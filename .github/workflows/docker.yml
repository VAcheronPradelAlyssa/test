name: Docker Build & Publish

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Build et test des images Docker
  docker-build:
    name: Build & Test Docker Images
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker Images
      run: |
        echo "ðŸ”¨ Building Docker images..."
        docker build -t test-bobapp-backend:test ./back
        docker build -t test-bobapp-frontend:test ./front
        echo "âœ… Images built successfully!"

    - name: Test Images Locally
      run: |
        echo "ðŸ§ª Testing images locally..."
        
        # Test backend
        docker run -d --name test-backend -p 8080:8080 test-bobapp-backend:test
        sleep 15
        
        echo "Testing backend endpoint..."
        curl -f http://localhost:8080/api/joke && echo "âœ… Backend OK" || exit 1
        
        docker stop test-backend
        docker rm test-backend
        
        # Test frontend  
        docker run -d --name test-frontend -p 4020:80 test-bobapp-frontend:test
        sleep 10
        
        echo "Testing frontend..."
        curl -f http://localhost:4020 && echo "âœ… Frontend OK" || exit 1
        
        docker stop test-frontend
        docker rm test-frontend
        
        echo "âœ… All tests passed!"

  # Publication sur Docker Hub (seulement pour main)
  docker-publish:
    name: Publish to Docker Hub
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      run: |
        echo "sha_short=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
        echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

    - name: Build and Push Backend
      uses: docker/build-push-action@v5
      with:
        context: ./back
        push: true
        tags: |
          vacheronalyssa/test-bobapp-backend:latest
          vacheronalyssa/test-bobapp-backend:${{ steps.meta.outputs.sha_short }}
          vacheronalyssa/test-bobapp-backend:${{ steps.meta.outputs.date }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build and Push Frontend
      uses: docker/build-push-action@v5
      with:
        context: ./front
        push: true
        tags: |
          vacheronalyssa/test-bobapp-frontend:latest
          vacheronalyssa/test-bobapp-frontend:${{ steps.meta.outputs.sha_short }}
          vacheronalyssa/test-bobapp-frontend:${{ steps.meta.outputs.date }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Test Published Images
      run: |
        echo "ðŸ§ª Testing published images from Docker Hub..."
        
        # Test backend from Docker Hub
        docker run -d --name hub-backend -p 8080:8080 vacheronalyssa/test-bobapp-backend:latest
        sleep 20
        
        curl -f http://localhost:8080/api/joke && echo "âœ… Backend from Docker Hub OK" || exit 1
        docker stop hub-backend && docker rm hub-backend
        
        # Test frontend from Docker Hub
        docker run -d --name hub-frontend -p 4020:80 vacheronalyssa/test-bobapp-frontend:latest
        sleep 15
        
        curl -f http://localhost:4020 && echo "âœ… Frontend from Docker Hub OK" || exit 1
        docker stop hub-frontend && docker rm hub-frontend
        
        echo "ðŸŽ‰ All images published and tested successfully!"

    - name: Display Image Info
      run: |
        echo "ðŸ“¦ Published images:"
        echo "Backend: vacheronalyssa/test-bobapp-backend:latest"
        echo "Backend: vacheronalyssa/test-bobapp-backend:${{ steps.meta.outputs.sha_short }}"
        echo "Frontend: vacheronalyssa/test-bobapp-frontend:latest" 
        echo "Frontend: vacheronalyssa/test-bobapp-frontend:${{ steps.meta.outputs.sha_short }}"